<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
	  data-namespace-typo3-fluid="true">
	
	<f:layout name="Default" />

	<f:section name="content">

		<f:flashMessages />

<f:comment>
<f:debug>{_all}</f:debug>
<f:debug>{_all}</f:debug>

		<f:link.action action="list">Back to list</f:link.action><br />
		<f:link.action action="new">New Bookobject</f:link.action>
</f:comment>


<div class="clearer"></div>
<div class="legend">
	<div class="item">
		<div class="day partialDay day1">24</div><div class="legendTitle">teilweise</div>
	</div>
	<div class="item">
		<div class="day bookedDay day1">24</div><div class="legendTitle">belegt</div>
	</div>
	<div class="item">
		<div class="day vacantDay day1">24</div><div class="legendTitle">verf√ºgbar</div>
	</div>
</div>

<div class="clearer"></div>




		<div id="ajaxResult"></div>

<script>
	
	var id = <f:format.raw>{id}</f:format.raw>;
	var year = <f:format.raw>{year}</f:format.raw>;
	var month = <f:format.raw>{month}</f:format.raw>;
	var calendar = "<f:format.raw>{settings.defaultCalendar}</f:format.raw>";
	var bookobjectUid = '';
//var bookingDate = '';
	
	function getCalendar(m, y, calendar, bookingDate, bookobjectUid) {
		var ajaxRequestUrl = "index.php?eIDx=booking&id=" + id,
			requestParameter = {
				tx_booking_ajax : {
					controller : 'BookObject',
					action : 'ajaxPsr',
					year: y,
					month: m,
					calendar: calendar,
					date: bookingDate,
					bookobjectUid: bookobjectUid
				}
			};

		$.post(ajaxRequestUrl, requestParameter, function (data) {
			$('#ajaxResult').html(data);

			$("table.bookingTable").wrap('<div class="table-scrollable"></div>');

			$('table.tableMultiRow td.vacantDay div, table.tableMultiRow td.bookedDay div,' +
			  'table.tableMultiRow td.vacantWeekend div, table.tableMultiRow td.partialDay div').click(function() {
				var bookingDate = $(this).children().attr('date');
				var bookobjectUid = $(this).children().attr('objectUid');
				$('.tx-booking .legend').css('display', 'none');
				getCalendar(month, year, 'form', bookingDate, bookobjectUid);
				
				
			});

			$('.tx-booking table img.insertBooking').click(function() {
				var dayTime = $(this).attr('date');
				var hour = $(this).attr('hour');
				var bookobjectUid = $(this).attr('bookobjectUid');
				var memo = $('textarea#' + hour).val();
				insertBooking(bookobjectUid, dayTime, hour, memo);
			});		
			$('.tx-booking table img.deleteBooking').click(function() {
				var bookUid = $(this).attr('bookuid');
				deleteBooking(bookUid);
			});		
	
			$('.prevMonth').click(function() {
				month--;
				if (month == 0) {
					month = 12; year--;
				}
				getCalendar(month, year, 'month', '');
			});
			$('.nextMonth').click(function() {
				month++;
				if (month > 12) {
					month = 1; year++;
				}
				getCalendar(month, year, 'month', '');
			});

		});
	}

	function deleteBooking(bookUid, bookobjectUid, bookingDate) {
		var ajaxRequestUrl = "index.php?eIDx=booking&id=" + id,
			requestParameter = {
				tx_booking_ajax : {
					controller : 'BookObject',
					action : 'ajaxPsr',
					calendar: 'deleteBooking',
					date: bookingDate,
					bookobjectUid: bookobjectUid,
					bookUid: bookUid
				}
			};

		$.post(ajaxRequestUrl, requestParameter, function (data) {
			$('#ajaxResult').html(data);
			$("table.bookingTable").wrap('<div class="table-scrollable"></div>');
			eventFunctions();
		});
	}

	function insertBooking(bookobjectUid, dayTime, hour, memo) {
		var ajaxRequestUrl = "index.php?eIDx=booking&id=" + id,
			requestParameter = {
				tx_booking_ajax : {
					controller : 'BookObject',
					action : 'ajaxPsr',
					calendar: 'insertBooking',
					dayTime: dayTime,
					hour: hour,
					bookobjectUid: bookobjectUid,
					memo: memo
				}
			};

//console.log(requestParameter);			

		$.post(ajaxRequestUrl, requestParameter, function (data) {
			$('#ajaxResult').html(data);
			$("table.bookingTable").wrap('<div class="table-scrollable"></div>');
			eventFunctions();

		});
		
	}
	
	function eventFunctions() {
			$('.tx-booking table img.insertBooking').click(function() {
				var dayTime = $(this).attr('date');
				var hour = $(this).attr('hour');
				var bookobjectUid = $(this).attr('bookobjectUid');
				var memo = $('textarea#' + hour).val();
				insertBooking(bookobjectUid, dayTime, hour, memo);
			});		
			$('.tx-booking table img.deleteBooking').click(function() {
				var bookUid = $(this).attr('bookuid');
				deleteBooking(bookUid);
			});		
	}
	
	
	
	
	$(function() {

		getCalendar(<f:format.raw>{month},{year}</f:format.raw>, 'month');

//console.log($('.tableMultiRow td div').html());
//$('.monthMultiRow').css('font-size', '30px');
//		$('.monthMultiRow td div').css('border', '5px solid red !important');
//		$('table.tableMultiRow td.vacantDay div').click(function() {
//			alert(88);
//		});

	});


</script>


	<div class="clearer"></div>
	</f:section>
</html>